<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chapter Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .option { padding:10px; border:1px solid #ccc; border-radius:8px; margin:6px 0; cursor:pointer; }
    .option:hover { background:#f3f4f6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6">

    <!-- Page 1: Login -->
    <div id="loginSection">
      <h2 class="text-2xl font-bold mb-4">Student Details</h2>
      <input id="studentName" type="text" placeholder="Enter your name"
             class="border p-2 rounded w-1/2 mb-4 block">
      <input id="schoolName" type="text" placeholder="Enter your school name"
             class="border p-2 rounded w-1/2 mb-4 block">
      <button onclick="enterQuiz()"
              class="bg-blue-600 text-white px-6 py-2 rounded-xl shadow hover:bg-blue-700">
        Continue
      </button>
    </div>

    <!-- Page 2: Chapter selection -->
    <div id="chapterSection" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Select Chapter</h2>
      <ul id="chapterList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></ul>
    </div>

    <!-- Page 3: Quiz -->
    <div id="quizSection" class="hidden">
      <div class="flex justify-between mb-4">
        <span id="chapterTitle" class="text-xl font-bold"></span>
        <span id="timer" class="font-mono"></span>
      </div>
      <div id="questionContainer" class="mb-6"></div>
      <button onclick="submitQuiz()" 
              class="bg-green-600 text-white px-6 py-2 rounded-xl shadow hover:bg-green-700">
        Submit Quiz
      </button>
    </div>

    <!-- Page 4: Results -->
    <div id="resultSection" class="hidden text-center">
      <h2 class="text-2xl font-bold mb-4">Results</h2>
      <p id="scoreText" class="text-xl mb-4"></p>
      <div id="reviewContainer" class="text-left mb-4"></div>
      <button id="backToChaptersBtn" 
              class="bg-indigo-600 text-white px-6 py-2 rounded-xl shadow hover:bg-indigo-700">
        Back to Chapters
      </button>
    </div>

  </div>

  <script>
    // ðŸš¨ Replace with your Apps Script deployed web app URL
    const APP_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";

    let studentName = "";
    let schoolName = "";
    let currentChapter = "";
    let questions = [];
    let currentIndex = 0;
    let answers = {};
    let timer;
    let timeLeft = 300; // 5 minutes

    // Page 1 -> Page 2
    function enterQuiz() {
      studentName = document.getElementById("studentName").value.trim();
      schoolName = document.getElementById("schoolName").value.trim();

      if (!studentName || !schoolName) {
        alert("Please enter both your name and school name!");
        return;
      }

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("chapterSection").classList.remove("hidden");

      loadChapters();
    }

    // Fetch chapters list
    function loadChapters() {
      fetch(APP_URL + "?mode=chapters")
        .then(r => r.json())
        .then(data => {
          const list = document.getElementById("chapterList");
          list.innerHTML = "";
          if (!data.chapters || !data.chapters.length) {
            list.innerHTML = "<p>No chapters found</p>";
            return;
          }
          data.chapters.forEach(ch => {
            const li = document.createElement("li");
            li.innerHTML = `<button class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-xl"
                                   onclick="startQuiz('${ch}')">${ch}</button>`;
            list.appendChild(li);
          });
        })
        .catch(err => alert("Error loading chapters: " + err));
    }

    // Start quiz for a chapter
    function startQuiz(chapter) {
      currentChapter = chapter;
      fetch(APP_URL + "?mode=questions&chapter=" + encodeURIComponent(chapter))
        .then(r => r.json())
        .then(data => {
          if (!data.questions || !data.questions.length) {
            alert("No questions found for this chapter");
            return;
          }
          questions = shuffle(data.questions);
          currentIndex = 0;
          answers = {};
          showQuestion();

          document.getElementById("chapterSection").classList.add("hidden");
          document.getElementById("quizSection").classList.remove("hidden");
          document.getElementById("chapterTitle").innerText = chapter;

          timeLeft = 300;
          timer = setInterval(updateTimer, 1000);
        })
        .catch(err => alert("Error loading questions: " + err));
    }

    function showQuestion() {
      const q = questions[currentIndex];
      const container = document.getElementById("questionContainer");
      container.innerHTML = `
        <h3 class="text-lg font-semibold mb-2">Q${currentIndex+1}. ${q.question}</h3>
        ${q.options.map(opt => `
          <div class="option ${answers[q.id] === opt ? 'bg-blue-100' : ''}" 
               onclick="selectOption('${q.id}','${opt}')">${opt}</div>`).join("")}
        <div class="mt-4 flex justify-between">
          <button onclick="prevQuestion()" class="px-4 py-2 bg-gray-300 rounded">Prev</button>
          <button onclick="nextQuestion()" class="px-4 py-2 bg-gray-300 rounded">Next</button>
        </div>`;
    }

    function selectOption(qid, opt) {
      answers[qid] = opt;
      showQuestion();
    }

    function nextQuestion() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        showQuestion();
      }
    }
    function prevQuestion() {
      if (currentIndex > 0) {
        currentIndex--;
        showQuestion();
      }
    }

    // Timer
    function updateTimer() {
      if (timeLeft <= 0) {
        clearInterval(timer);
        submitQuiz();
        return;
      }
      document.getElementById("timer").innerText = formatTime(timeLeft);
      timeLeft--;
    }
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s < 10 ? '0'+s : s}`;
    }

    // Submit quiz
    function submitQuiz() {
      clearInterval(timer);

      let score = 0;
      questions.forEach(q => {
        if (answers[q.id] === q.correct) score++;
      });

      document.getElementById("quizSection").classList.add("hidden");
      document.getElementById("resultSection").classList.remove("hidden");
      document.getElementById("scoreText").innerText = 
        `${studentName} from ${schoolName}, your score: ${score}/${questions.length}`;

      const review = document.getElementById("reviewContainer");
      review.innerHTML = questions.map(q => `
        <div class="mb-2">
          <strong>${q.question}</strong><br>
          Your answer: ${answers[q.id] || "Not answered"}<br>
          Correct answer: ${q.correct}
        </div>`).join("");

      // Save to Google Sheets
      fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({ 
          action: "submitQuiz",
          name: studentName,
          school: schoolName,
          chapter: currentChapter,
          score,
          total: questions.length,
          answers
        })
      });
    }

    // Back button on results page
    document.getElementById("backToChaptersBtn").onclick = function() {
      document.getElementById("resultSection").classList.add("hidden");
      document.getElementById("chapterSection").classList.remove("hidden");
      currentChapter = "";
      questions = [];
      currentIndex = 0;
      answers = {};
      clearInterval(timer);
    };

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }
  </script>
</body>
</html>
